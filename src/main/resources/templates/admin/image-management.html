<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Image Management - Admin Panel</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/admin.css" rel="stylesheet">
    
    <style>
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .category-card {
            transition: transform 0.2s ease;
        }
        .category-card:hover {
            transform: translateY(-2px);
        }
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        .storage-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }
        .cleanup-log {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5 class="text-white">Admin Panel</h5>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/plans">
                                <i class="fas fa-map me-2"></i>
                                Plans
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/registrations">
                                <i class="fas fa-users me-2"></i>
                                Registrations
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="/admin/images">
                                <i class="fas fa-images me-2"></i>
                                Image Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/cron">
                                <i class="fas fa-clock me-2"></i>
                                Cron Jobs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/settings">
                                <i class="fas fa-cog me-2"></i>
                                Settings
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-white" href="/" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>
                                View Site
                            </a>
                        </li>
                        <li class="nav-item">
                            <form th:action="@{/admin/logout}" method="post" style="display: inline;">
                                <button type="submit" class="nav-link text-white btn btn-link p-0 border-0 text-start w-100" style="background: none;">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Logout
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-images me-2"></i>Image Management
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-outline-primary me-2" onclick="refreshStorageStats()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh Stats
                        </button>
                        <button type="button" class="btn btn-warning" onclick="triggerManualCleanup()">
                            <i class="fas fa-broom me-1"></i>Manual Cleanup
                        </button>
                    </div>
                </div>

                <!-- Error/Success Messages -->
                <div id="alertContainer"></div>

                <!-- Storage Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card storage-stat">
                            <div class="card-body text-center">
                                <i class="fas fa-hdd fa-2x mb-2"></i>
                                <h5 class="card-title">Total Storage</h5>
                                <p class="card-text fs-4" th:text="${storageStats != null ? #numbers.formatDecimal(storageStats.totalStorageUsedMB, 1, 2) + ' MB' : '0 MB'}">0 MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card storage-stat">
                            <div class="card-body text-center">
                                <i class="fas fa-file-image fa-2x mb-2"></i>
                                <h5 class="card-title">Images</h5>
                                <p class="card-text fs-4" th:text="${storageStats != null ? #numbers.formatDecimal(storageStats.imageStorageUsedMB, 1, 2) + ' MB' : '0 MB'}">0 MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card storage-stat">
                            <div class="card-body text-center">
                                <i class="fas fa-file-alt fa-2x mb-2"></i>
                                <h5 class="card-title">Documents</h5>
                                <p class="card-text fs-4" th:text="${storageStats != null ? #numbers.formatDecimal(storageStats.documentStorageUsedMB, 1, 2) + ' MB' : '0 MB'}">0 MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card storage-stat">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <h5 class="card-title">Active Images</h5>
                                <p class="card-text fs-4" th:text="${storageStats != null ? storageStats.activeImages : '0'}">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Background Media Toggle -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-toggle-on me-2"></i>Background Media Settings
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Enable Background Media</h6>
                                        <small class="text-muted">Toggle to enable/disable background video or image on the hero section</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="backgroundMediaToggle"
                                               th:checked="${backgroundMediaEnabled != null ? backgroundMediaEnabled : true}"
                                               onchange="toggleBackgroundMedia(this.checked)">
                                        <label class="form-check-label" for="backgroundMediaToggle">
                                            <span id="toggleStatus" th:text="${backgroundMediaEnabled != null and backgroundMediaEnabled ? 'Enabled' : 'Disabled'}">Enabled</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        When disabled, the hero section will use a plain CSS background instead of media files.
                                    </small>
                                </div>

                                <!-- Hero Blur Intensity Slider -->
                                <hr class="my-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Hero Section Blur Intensity</h6>
                                        <small class="text-muted">Adjust background blur intensity for hero content sections (0 = no blur, 10 = maximum blur)</small>
                                    </div>
                                    <div class="d-flex align-items-center" style="min-width: 200px;">
                                        <input type="range" class="form-range me-3" id="blurIntensitySlider"
                                               min="0" max="10" step="1"
                                               th:value="${heroBlurIntensity != null ? heroBlurIntensity : 3}"
                                               oninput="updateBlurIntensity(this.value)">
                                        <span class="badge bg-primary" id="blurIntensityValue"
                                              th:text="${heroBlurIntensity != null ? heroBlurIntensity : 3}">3</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Categories -->
                <div class="row">
                    <div th:each="category : ${imageCategories}" class="col-lg-6 mb-4">
                        <div class="card category-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0" th:text="${category.displayName}">Category Name</h5>
                                <span class="badge bg-primary" th:text="${category.value}">category_key</span>
                            </div>
                            <div class="card-body">
                                <!-- Current Image Display -->
                                <div class="mb-3" th:if="${currentImages.containsKey(category.value)}">
                                    <h6 class="text-muted mb-2">Current Image:</h6>
                                    <div class="d-flex align-items-center">
                                        <img th:src="${currentImages.get(category.value).filePath.startsWith('http') ? currentImages.get(category.value).filePath : '/uploads/images/' + currentImages.get(category.value).storedFilename}" 
                                             th:alt="${currentImages.get(category.value).altText}"
                                             class="image-preview me-3">
                                        <div>
                                            <p class="mb-1"><strong th:text="${currentImages.get(category.value).originalFilename}">filename.jpg</strong></p>
                                            <p class="mb-1 text-muted" th:text="${currentImages.get(category.value).formattedFileSize}">Size</p>
                                            <p class="mb-0 text-muted" th:text="${#temporals.format(currentImages.get(category.value).uploadDate, 'MMM dd, yyyy HH:mm')}">Upload Date</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" th:unless="${currentImages.containsKey(category.value)}">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No image currently set for this category.
                                    </div>
                                </div>

                                <!-- Upload Options -->
                                <div class="row">
                                    <!-- File Upload -->
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Upload File:</h6>
                                        <div class="upload-zone" th:id="'upload-zone-' + ${category.value}"
                                             th:data-category="${category.value}"
                                             onclick="document.getElementById('file-input-' + this.dataset.category).click()">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                                            <p class="mb-0 text-muted">Click to select file or drag & drop</p>
                                            <small class="text-muted">
                                                Images (<span th:text="${T(java.lang.Math).round(T(java.lang.Double).parseDouble(@environment.getProperty('app.file-storage.max-image-size', '5242880')) / 1024 / 1024)}">5</span>MB max) •
                                                Videos (<span th:text="${T(java.lang.Math).round(T(java.lang.Double).parseDouble(@environment.getProperty('app.file-storage.max-video-size', '52428800')) / 1024 / 1024)}">50</span>MB max) •
                                                JPG, PNG, WebP, MP4
                                            </small>
                                        </div>
                                        <input type="file" th:id="'file-input-' + ${category.value}"
                                               class="d-none" accept="image/jpeg,image/jpg,image/png,image/webp,video/mp4,video/webm,video/ogg"
                                               th:data-category="${category.value}"
                                               onchange="handleFileUpload(this, this.dataset.category)">
                                    </div>
                                    
                                    <!-- URL Input -->
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Or Enter URL:</h6>
                                        <div class="input-group mb-2">
                                            <input type="url" class="form-control" th:id="'url-input-' + ${category.value}" 
                                                   placeholder="https://example.com/image.jpg">
                                            <button class="btn btn-outline-primary" type="button"
                                                    th:data-category="${category.value}"
                                                    onclick="handleUrlUpload(this.dataset.category)">
                                                <i class="fas fa-link"></i>
                                            </button>
                                        </div>
                                        <input type="text" class="form-control mb-2" th:id="'alt-text-' + ${category.value}" 
                                               placeholder="Alt text (optional)">
                                        <textarea class="form-control" th:id="'description-' + ${category.value}" 
                                                  rows="2" placeholder="Description (optional)"></textarea>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="mt-3 d-flex justify-content-between">
                                    <button type="button" class="btn btn-success"
                                            th:data-category="${category.value}"
                                            onclick="uploadImage(this.dataset.category)">
                                        <i class="fas fa-upload me-1"></i>Upload File
                                    </button>
                                    <button type="button" class="btn btn-info"
                                            th:data-category="${category.value}"
                                            onclick="saveFromUrl(this.dataset.category)">
                                        <i class="fas fa-link me-1"></i>Save from URL
                                    </button>
                                    <button type="button" class="btn btn-danger"
                                            th:if="${currentImages.containsKey(category.value)}"
                                            th:data-image-id="${currentImages.get(category.value).id}"
                                            th:data-category="${category.value}"
                                            onclick="deleteImage(this.dataset.imageId, this.dataset.category)">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Cleanup Logs -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-history me-2"></i>Recent Cleanup Activity
                                </h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadCleanupLogs()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="cleanup-logs-container">
                                    <div th:if="${recentCleanupLogs != null and !recentCleanupLogs.isEmpty()}">
                                        <div th:each="log : ${recentCleanupLogs}" class="cleanup-log border-bottom py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span th:class="${log.success ? 'badge bg-success' : 'badge bg-danger'}" 
                                                          th:text="${log.success ? 'SUCCESS' : 'FAILED'}">Status</span>
                                                    <span class="ms-2" th:text="${log.message}">Cleanup message</span>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(log.startTime, 'MMM dd, yyyy HH:mm')}">Date</small>
                                            </div>
                                            <div class="mt-1" th:if="${log.success}">
                                                <small class="text-muted">
                                                    Files deleted: <span th:text="${log.totalFilesDeleted}">0</span> • 
                                                    Space freed: <span th:text="${#numbers.formatDecimal(log.totalSpaceFreedMB, 1, 2)}">0</span> MB
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${recentCleanupLogs == null or recentCleanupLogs.isEmpty()}" class="text-center text-muted py-3">
                                        <i class="fas fa-info-circle me-2"></i>No cleanup activity recorded yet.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Configuration Script -->
    <script th:inline="javascript">
        // File size configuration from server
        window.FILE_SIZE_CONFIG = {
            maxImageSize: /*[[${@environment.getProperty('app.file-storage.max-image-size', '5242880')}]]*/ 5242880,
            maxVideoSize: /*[[${@environment.getProperty('app.file-storage.max-video-size', '52428800')}]]*/ 52428800,
            maxPhotoSize: /*[[${@environment.getProperty('app.file-storage.max-photo-size', '2097152')}]]*/ 2097152,
            maxDocumentSize: /*[[${@environment.getProperty('app.file-storage.max-document-size', '5242880')}]]*/ 5242880
        };
    </script>

    <script>
        // Global variables for file uploads
        let selectedFiles = {};

        // Get CSRF token
        const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : null;
        const csrfHeader = csrfHeaderElement ? csrfHeaderElement.getAttribute('content') : null;

        // Handle file selection
        function handleFileUpload(input, category) {
            console.log('handleFileUpload called for category:', category);
            const file = input.files[0];
            if (file) {
                console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
                selectedFiles[category] = file;
                const uploadZone = document.getElementById('upload-zone-' + category);
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                uploadZone.innerHTML =
                    '<i class="fas fa-file-image fa-2x mb-2 text-success"></i>' +
                    '<p class="mb-0 text-success">' + file.name + '</p>' +
                    '<small class="text-muted">' + fileSizeMB + ' MB</small>';
            } else {
                console.log('No file selected');
            }
        }

        // Handle URL upload button click
        function handleUrlUpload(category) {
            saveFromUrl(category);
        }

        // Upload image file
        function uploadImage(category) {
            console.log('uploadImage called for category:', category);
            const file = selectedFiles[category];
            if (!file) {
                console.log('No file selected for category:', category);
                showAlert('Please select a file first.', 'warning');
                return;
            }
            console.log('Starting upload for file:', file.name);

            // Validate file size based on type
            const isVideo = file.type.startsWith('video/');
            const maxSize = isVideo ? window.FILE_SIZE_CONFIG.maxVideoSize : window.FILE_SIZE_CONFIG.maxImageSize;

            if (file.size > maxSize) {
                const maxSizeMB = maxSize / (1024 * 1024);
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                const fileType = isVideo ? 'videos' : 'images';
                showAlert('File size (' + fileSizeMB + 'MB) exceeds maximum allowed size of ' + maxSizeMB + 'MB for ' + fileType + '.', 'danger');
                return;
            }

            const altText = document.getElementById('alt-text-' + category).value;
            const description = document.getElementById('description-' + category).value;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', category);
            formData.append('altText', altText);
            formData.append('description', description);

            // Show progress indicator
            showUploadProgress(category, 'Uploading...');

            // Create XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();

            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    updateUploadProgress(category, percentComplete);
                }
            });

            // Handle completion
            xhr.addEventListener('load', function() {
                hideUploadProgress(category);
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            showAlert('Image uploaded successfully!', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showAlert('Upload failed: ' + data.message, 'danger');
                        }
                    } catch (e) {
                        showAlert('Upload failed: Invalid server response', 'danger');
                    }
                } else {
                    showAlert('Upload failed: Server error (' + xhr.status + ')', 'danger');
                }
            });

            // Handle errors
            xhr.addEventListener('error', function() {
                hideUploadProgress(category);
                showAlert('Upload failed: Network error. Please check your connection and try again.', 'danger');
            });

            // Handle timeout
            xhr.addEventListener('timeout', function() {
                hideUploadProgress(category);
                showAlert('Upload failed: Request timed out. Please try again.', 'danger');
            });

            // Set timeout (2 minutes for large files)
            xhr.timeout = 120000;

            // Send request
            xhr.open('POST', '/admin/images/upload');
            if (csrfToken && csrfHeader) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            }
            xhr.send(formData);
        }

        // Save image from URL
        function saveFromUrl(category) {
            const imageUrl = document.getElementById('url-input-' + category).value;
            if (!imageUrl.trim()) {
                showAlert('Please enter an image URL.', 'warning');
                return;
            }

            // Basic URL validation
            try {
                new URL(imageUrl.trim());
            } catch (e) {
                showAlert('Please enter a valid URL.', 'warning');
                return;
            }

            // Check if it's a YouTube URL and provide specific feedback
            const isYouTubeUrl = imageUrl.includes('youtube.com') || imageUrl.includes('youtu.be');
            if (isYouTubeUrl) {
                console.log('YouTube URL detected:', imageUrl);
                showUploadProgress(category, 'Processing YouTube video...');
            } else {
                showUploadProgress(category, 'Saving image from URL...');
            }

            const altText = document.getElementById('alt-text-' + category).value;
            const description = document.getElementById('description-' + category).value;

            const formData = new FormData();
            formData.append('imageUrl', imageUrl.trim());
            formData.append('category', category);
            formData.append('altText', altText);
            formData.append('description', description);

            showUploadProgress(category, 'Saving from URL...');

            const headers = {};
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            fetch('/admin/images/url', {
                method: 'POST',
                headers: headers,
                body: formData
            })
            .then(response => {
                hideUploadProgress(category);
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const isYouTubeUrl = imageUrl.includes('youtube.com') || imageUrl.includes('youtu.be');
                    const successMessage = isYouTubeUrl ? 'YouTube video processed successfully!' : 'Image saved successfully!';
                    showAlert(successMessage, 'success');

                    // Show thumbnail preview for YouTube videos
                    if (isYouTubeUrl) {
                        showYouTubeThumbnail(category, imageUrl);
                    }

                    setTimeout(() => location.reload(), 1500);
                } else {
                    const isYouTubeUrl = imageUrl.includes('youtube.com') || imageUrl.includes('youtu.be');
                    const errorPrefix = isYouTubeUrl ? 'YouTube video processing failed: ' : 'Save failed: ';
                    showAlert(errorPrefix + data.message, 'danger');
                }
            })
            .catch(error => {
                hideUploadProgress(category);
                if (error.name === 'TypeError') {
                    showAlert('Save failed: Network error. Please check your connection and try again.', 'danger');
                } else {
                    showAlert('Save failed: ' + error.message, 'danger');
                }
            });
        }

        // Delete image
        function deleteImage(imageId, category) {
            if (!confirm('Are you sure you want to delete this image?')) {
                return;
            }

            showLoading('Deleting image...');

            const deleteHeaders = {};
            if (csrfToken && csrfHeader) {
                deleteHeaders[csrfHeader] = csrfToken;
            }

            fetch('/admin/images/' + imageId, {
                method: 'DELETE',
                headers: deleteHeaders
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showAlert('Image deleted successfully!', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert('Delete failed: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Delete failed: ' + error.message, 'danger');
            });
        }

        // Trigger manual cleanup
        function triggerManualCleanup() {
            if (!confirm('This will clean up old files and free storage space. Continue?')) {
                return;
            }

            showLoading('Running cleanup...');

            const cleanupHeaders = {};
            if (csrfToken && csrfHeader) {
                cleanupHeaders[csrfHeader] = csrfToken;
            }

            fetch('/admin/images/cleanup', {
                method: 'POST',
                headers: cleanupHeaders
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    const spaceFreed = data.spaceFreedMB.toFixed(2);
                    showAlert('Cleanup completed! Deleted ' + data.filesDeleted + ' files, freed ' + spaceFreed + ' MB', 'success');
                    setTimeout(function() { location.reload(); }, 2000);
                } else {
                    showAlert('Cleanup failed: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Cleanup failed: ' + error.message, 'danger');
            });
        }

        // Refresh storage statistics
        function refreshStorageStats() {
            showLoading('Refreshing statistics...');
            setTimeout(() => location.reload(), 1000);
        }

        // Load cleanup logs
        function loadCleanupLogs() {
            const logHeaders = {};
            if (csrfToken && csrfHeader) {
                logHeaders[csrfHeader] = csrfToken;
            }

            fetch('/admin/images/cleanup-logs', {
                method: 'GET',
                headers: logHeaders
            })
            .then(response => response.json())
            .then(logs => {
                const container = document.getElementById('cleanup-logs-container');
                if (logs.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-info-circle me-2"></i>No cleanup activity recorded yet.</div>';
                    return;
                }

                let html = '';
                logs.slice(0, 5).forEach(log => {
                    const statusBadge = log.success ? '<span class="badge bg-success">SUCCESS</span>' : '<span class="badge bg-danger">FAILED</span>';
                    const date = new Date(log.startTime).toLocaleDateString('en-US', { 
                        month: 'short', day: 'numeric', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                    
                    html += '<div class="cleanup-log border-bottom py-2">' +
                        '<div class="d-flex justify-content-between align-items-center">' +
                            '<div>' +
                                statusBadge +
                                '<span class="ms-2">' + log.message + '</span>' +
                            '</div>' +
                            '<small class="text-muted">' + date + '</small>' +
                        '</div>';

                    if (log.success) {
                        const spaceFreed = log.totalSpaceFreedMB.toFixed(2);
                        html += '<div class="mt-1">' +
                            '<small class="text-muted">' +
                                'Files deleted: ' + log.totalFilesDeleted + ' • ' +
                                'Space freed: ' + spaceFreed + ' MB' +
                            '</small>' +
                        '</div>';
                    }

                    html += '</div>';
                });
                
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading cleanup logs:', error);
            });
        }

        // Utility functions
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>';
            alertContainer.innerHTML = alertHtml;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        function showLoading(message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '<div class="alert alert-info" role="alert">' +
                '<i class="fas fa-spinner fa-spin me-2"></i>' + message +
                '</div>';
        }

        function hideLoading() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadZones = document.querySelectorAll('.upload-zone');
            
            uploadZones.forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                zone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const category = this.id.split('-')[2];
                        const fileInput = document.getElementById('file-input-' + category);
                        fileInput.files = files;
                        handleFileUpload(fileInput, category);
                    }
                });
            });
        });

        // Progress indicator functions
        function showUploadProgress(category, message) {
            const uploadZone = document.getElementById('upload-zone-' + category);
            uploadZone.innerHTML = '<div class="upload-progress">' +
                '<div class="spinner-border text-primary mb-2" role="status">' +
                    '<span class="visually-hidden">Loading...</span>' +
                '</div>' +
                '<p class="mb-2">' + message + '</p>' +
                '<div class="progress" style="height: 8px;">' +
                    '<div id="progress-bar-' + category + '" class="progress-bar progress-bar-striped progress-bar-animated"' +
                         ' role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>' +
                '</div>' +
                '<small id="progress-text-' + category + '" class="text-muted">0%</small>' +
                '</div>';
        }

        function updateUploadProgress(category, percent) {
            const progressBar = document.getElementById('progress-bar-' + category);
            const progressText = document.getElementById('progress-text-' + category);

            if (progressBar && progressText) {
                const roundedPercent = Math.round(percent);
                progressBar.style.width = roundedPercent + '%';
                progressBar.setAttribute('aria-valuenow', roundedPercent);
                progressText.textContent = roundedPercent + '%';
            }
        }

        function hideUploadProgress(category) {
            const uploadZone = document.getElementById('upload-zone-' + category);
            uploadZone.innerHTML = '<i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>' +
                '<p class="mb-0 text-muted">Drag & drop files here or click to browse</p>' +
                '<small class="text-muted">Supported: Images (5MB max) and Videos (50MB max)</small>';
        }

        // Show YouTube thumbnail preview
        function showYouTubeThumbnail(category, youtubeUrl) {
            const videoId = extractYouTubeVideoId(youtubeUrl);
            if (videoId) {
                const thumbnailUrl = 'https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg';
                const uploadZone = document.getElementById('upload-zone-' + category);
                uploadZone.innerHTML = '<div class="text-center">' +
                    '<img src="' + thumbnailUrl + '" alt="YouTube Video Thumbnail" class="img-fluid rounded mb-2" style="max-height: 120px;">' +
                    '<p class="mb-0 text-success"><i class="fab fa-youtube text-danger me-1"></i>YouTube Video</p>' +
                    '<small class="text-muted">Video ID: ' + videoId + '</small>' +
                    '</div>';
            }
        }

        // Extract YouTube video ID from URL
        function extractYouTubeVideoId(url) {
            try {
                if (url.includes('youtube.com/watch?v=')) {
                    const urlParams = new URLSearchParams(new URL(url).search);
                    return urlParams.get('v');
                } else if (url.includes('youtu.be/')) {
                    return url.split('youtu.be/')[1].split('?')[0];
                } else if (url.includes('youtube.com/embed/')) {
                    return url.split('youtube.com/embed/')[1].split('?')[0];
                }
            } catch (e) {
                console.error('Error extracting YouTube video ID:', e);
            }
            return null;
        }

        // Background media toggle function
        function toggleBackgroundMedia(enabled) {
            showLoading('Updating background media settings...');

            const toggleHeaders = {
                'Content-Type': 'application/json'
            };
            if (csrfToken && csrfHeader) {
                toggleHeaders[csrfHeader] = csrfToken;
            }

            fetch('/admin/images/toggle-background-media', {
                method: 'POST',
                headers: toggleHeaders,
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    const statusText = enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('toggleStatus').textContent = statusText;
                    showAlert('Background media ' + statusText.toLowerCase() + ' successfully!', 'success');
                } else {
                    showAlert('Error updating background media settings: ' + data.message, 'danger');
                    // Revert toggle state
                    document.getElementById('backgroundMediaToggle').checked = !enabled;
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Error updating background media settings: ' + error.message, 'danger');
                // Revert toggle state
                document.getElementById('backgroundMediaToggle').checked = !enabled;
            });
        }

        // Update blur intensity function
        function updateBlurIntensity(intensity) {
            // Update the display value
            document.getElementById('blurIntensityValue').textContent = intensity;

            // Debounce the API call to avoid too many requests
            clearTimeout(window.blurUpdateTimeout);
            window.blurUpdateTimeout = setTimeout(function() {
                showLoading('Updating blur intensity...');

                const blurHeaders = {
                    'Content-Type': 'application/json'
                };
                if (csrfToken && csrfHeader) {
                    blurHeaders[csrfHeader] = csrfToken;
                }

                fetch('/admin/images/update-blur-intensity', {
                    method: 'POST',
                    headers: blurHeaders,
                    body: JSON.stringify({ intensity: parseInt(intensity) })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showAlert('Blur intensity updated to ' + intensity + ' successfully!', 'success');
                    } else {
                        showAlert('Error updating blur intensity: ' + data.message, 'danger');
                        // Revert slider value
                        document.getElementById('blurIntensitySlider').value = data.intensity || 3;
                        document.getElementById('blurIntensityValue').textContent = data.intensity || 3;
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error updating blur intensity: ' + error.message, 'danger');
                });
            }, 500); // 500ms debounce
        }

        // Initialize drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Add drag and drop event listeners to all upload zones
            document.querySelectorAll('.upload-zone').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                zone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const category = this.dataset.category;
                        const fileInput = document.getElementById('file-input-' + category);
                        fileInput.files = files;
                        handleFileUpload(fileInput, category);
                    }
                });
            });
        });
    </script>
</body>
</html>
